# syntax=docker/dockerfile:1
# Multi-runtime compatible container image for worktree-flow e2e testing
# Works with both Docker and Podman (including rootless mode)
FROM python:3.11-alpine

# OCI standard labels (compatible with both runtimes)
LABEL org.opencontainers.image.title="worktree-flow-test"
LABEL org.opencontainers.image.description="Test container for worktree-flow e2e"
LABEL org.opencontainers.image.source="https://github.com/fearnworks/agentic-engineer"

# Install minimal dependencies
RUN pip install --no-cache-dir flask

# Copy health endpoint server
COPY healthcheck.py /app/healthcheck.py
WORKDIR /app

# Create non-root user for rootless compatibility
# UID 1000 is typically the first non-root user, works well with --userns=keep-id
RUN adduser -D -u 1000 appuser
USER appuser

# Expose port >= 1024 for rootless compatibility
# Rootless containers cannot bind to privileged ports (<1024)
EXPOSE 8080

# Health check using wget (available in alpine)
HEALTHCHECK --interval=5s --timeout=3s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1

CMD ["python", "healthcheck.py"]
